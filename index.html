<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>SMARTLend</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{font-family:Arial;background:#2a2a2a;padding:20px;}
.container{max-width:1000px;margin:auto;background:white;border-radius:5px;}
.header{background:#333;color:white;padding:20px;text-align:center;}
.content{padding:20px;}

.form-group{display:flex;gap:10px;flex-wrap:wrap;}
input,button{padding:8px;border:1px solid #ccc;border-radius:4px;}
button{cursor:pointer;color:white;}
button[type="submit"]{background:#4CAF50;}

.controls{display:none;margin-top:10px;gap:10px;}
.controls button{flex:1;}
#removeOfflineBtn{background:#f44336;}
#exportExcelBtn{background:#2196F3;}
#exportTextBtn{background:#FF9800;}

.admin-btn{background:#555;margin-bottom:10px;}

table{width:100%;border-collapse:collapse;margin-top:10px;}
th{background:#444;color:white;padding:10px;}
td{padding:8px;border:1px solid #ddd;}

.status-online{background:#c8e6c9;color:#2e7d32;padding:3px 8px;border-radius:3px;}
.status-offline{background:#ffcccc;color:#c62828;padding:3px 8px;border-radius:3px;}

.action-btn{padding:5px 10px;border:none;border-radius:3px;}
.return-btn{background:#4CAF50;}
.remove-btn{background:#f44336;}
</style>
</head>

<body>

<div class="container">
<div class="header"><h1>SMARTLend</h1></div>

<div class="content">

<button class="admin-btn" id="loginAdminBtn" onclick="loginAdmin()">Admin Login</button>
<button class="admin-btn" id="logoutAdminBtn" onclick="logoutAdmin()" style="display:none;">Logout Admin</button>

<form id="logForm">
<div class="form-group">
<input id="deviceName" type="text" placeholder="Device (PC 1-50 or TB 1-50)" required>
<input id="borrowerName" type="text" placeholder="Borrower's name" required>
<input type="date" id="dateBorrowed">
<button type="submit">Add & Start</button>
</div>
</form>

<div class="controls" id="controls">
<button id="removeOfflineBtn">Remove All Offline</button>
<button id="exportExcelBtn">Export Excel</button>
<button id="exportTextBtn">Export Text</button>
</div>

<table>
<thead>
<tr>
<th>Device</th>
<th>Status</th>
<th>Borrower</th>
<th>Time</th>
<th>Date</th>
<th>Action</th>
</tr>
</thead>
<tbody id="logTableBody"></tbody>
</table>

</div>
</div>

<script>

const ADMIN_PASSWORD="admin123";
let adminMode = localStorage.getItem("adminMode") === "true";

function loginAdmin(){
    const pass = prompt("Admin password:");
    if(pass === ADMIN_PASSWORD){
        adminMode = true;
        localStorage.setItem("adminMode","true");
        document.getElementById("controls").style.display="flex";
        document.getElementById("logoutAdminBtn").style.display="inline-block";
        document.getElementById("loginAdminBtn").style.display="none";
        render();
        alert("Admin mode enabled.");
    } else alert("Wrong password.");
}

function logoutAdmin(){
    adminMode = false;
    localStorage.setItem("adminMode","false");
    document.getElementById("controls").style.display="none";
    document.getElementById("logoutAdminBtn").style.display="none";
    document.getElementById("loginAdminBtn").style.display="inline-block";
    alert("Admin mode disabled.");
    render();
}

// Show controls if already in admin mode
if(adminMode){
    document.getElementById("controls").style.display="flex";
    document.getElementById("logoutAdminBtn").style.display="inline-block";
    document.getElementById("loginAdminBtn").style.display="none";
}

let logs=JSON.parse(localStorage.getItem('deviceLogs'))||[];
let timerInterval=null;

const tableBody=document.getElementById('logTableBody');
const form=document.getElementById('logForm');
const deviceInput=document.getElementById('deviceName');
const borrowerInput=document.getElementById('borrowerName');
const dateInput=document.getElementById('dateBorrowed');

const today=new Date().toISOString().slice(0,10);
dateInput.min=today;
dateInput.max=today;
dateInput.value=today;

function saveLogs(){localStorage.setItem('deviceLogs',JSON.stringify(logs));}

function formatElapsed(ms){
    if(!ms) return '0h 0m 0s';
    const s=Math.floor(ms/1000);
    return `${Math.floor(s/3600)}h ${Math.floor((s%3600)/60)}m ${s%60}s`;
}

function elapsedTime(start,end){
    return formatElapsed((end??Date.now())-start);
}

function render(){
    tableBody.innerHTML='';
    if(!logs.length){
        tableBody.innerHTML='<tr><td colspan="6" style="text-align:center;color:#999;padding:30px;">No logs</td></tr>';
        return;
    }

    logs.forEach((log,i)=>{
        const tr=document.createElement('tr');
        const statusClass=log.status==='Online'?'status-online':'status-offline';
        const statusText=log.status==='Online'?'ðŸŸ¢ Online':'ðŸ”´ Offline';

        tr.innerHTML=`
        <td>${log.deviceName}</td>
        <td><span class="${statusClass}">${statusText}</span></td>
        <td>${log.borrowerName}</td>
        <td id="timer-${i}">${elapsedTime(log.startTime,log.endTime)}</td>
        <td>${log.dateBorrowed}</td>
        <td>
        ${log.status==='Online'
            ? `<button class="action-btn return-btn" onclick="markReturned(${i})">Return</button>`
            : adminMode
            ? `<button class="action-btn remove-btn" onclick="removeLog(${i})">Remove</button>`
            : ''}
        </td>`;

        tableBody.appendChild(tr);
    });
    startTimer();
}

function startTimer(){
    if(timerInterval) return;
    timerInterval=setInterval(()=>{
        logs.forEach((log,i)=>{
            if(log.status!=='Online') return;
            const el=document.getElementById(`timer-${i}`);
            if(el) el.textContent=elapsedTime(log.startTime);
        });
    },1000);
}

function markReturned(i){
    logs[i].status='Offline';
    logs[i].endTime=Date.now();
    saveLogs();
    render();
}

function removeLog(i){
    if(!adminMode) return;
    logs.splice(i,1);
    saveLogs();
    render();
}

function isValidDevice(name){
    name=name.trim().toUpperCase();
    const pc=name.match(/^PC\s*(\d+)$/);
    const tb=name.match(/^TB\s*(\d+)$/);
    if(pc) return pc[1]>=1 && pc[1]<=50;
    if(tb) return tb[1]>=1 && tb[1]<=50;
    return false;
}

form.addEventListener('submit',e=>{
    e.preventDefault();
    const d=deviceInput.value.trim();
    const b=borrowerInput.value.trim();
    const date=dateInput.value;

    if(date!==today) return alert("Date locked to today.");
    if(!isValidDevice(d)) return alert("Invalid device.");

    logs.push({
        deviceName:d.toUpperCase(),
        borrowerName:b,
        status:'Online',
        startTime:Date.now(),
        endTime:null,
        dateBorrowed:date
    });

    saveLogs();
    form.reset();
    dateInput.value=today;
    render();
});

document.getElementById('removeOfflineBtn').onclick=()=>{
    if(!adminMode) return;
    logs=logs.filter(l=>l.status==='Online');
    saveLogs();
    render();
};

document.getElementById('exportExcelBtn').onclick=()=>{
    if(!adminMode) return;
    const data=logs.map(l=>({
        Device:l.deviceName,
        Status:l.status,
        Borrower:l.borrowerName,
        Time:elapsedTime(l.startTime,l.endTime),
        Date:l.dateBorrowed
    }));
    const ws=XLSX.utils.json_to_sheet(data);
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,'Logs');
    XLSX.writeFile(wb,'device-logs.xlsx');
};

document.getElementById('exportTextBtn').onclick=()=>{
    if(!adminMode) return;
    let text="SMARTLend Logs\n\n";
    logs.forEach((l,i)=>{
        text+=`#${i+1} ${l.deviceName} | ${l.borrowerName} | ${l.status}\n`;
    });
    const blob=new Blob([text],{type:'text/plain'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;
    a.download='device-logs.txt';
    a.click();
    URL.revokeObjectURL(url);
};

window.markReturned=markReturned;
window.removeLog=removeLog;

render();

</script>

</body>
</html>
